---

- name: Get next available vmid
  ansible.builtin.command: pvesh get /cluster/nextid
  register: home_assistant_setup_next_vmid
  delegate_to: "{{ vms_proxmox_node }}"
  changed_when: false

- name: Set home_assistant_setup_vmid fact
  ansible.builtin.set_fact:
    home_assistant_setup_vmid: "{{ vms_vmid | default(home_assistant_setup_next_vmid.stdout) }}"

- name: Check if VM exists
  community.proxmox.proxmox_vm_info:
    api_host: "{{ global_proxmox_api_host }}"
    api_user: "{{ global_proxmox_api_user }}"
    api_token_id: "{{ global_proxmox_api_token_id | default(omit) }}"
    api_token_secret: "{{ global_proxmox_api_token }}"
    api_password: "{{ global_proxmox_api_password }}"
    node: "{{ vms_proxmox_node }}"
    vmid: "{{ home_assistant_setup_vmid | int }}"
    config: "current"
  delegate_to: localhost
  register: home_assistant_setup_vm_info
  failed_when: false
  changed_when: false

- name: Show home_assistant_setup_vm_info debug
  ansible.builtin.debug:
    var: home_assistant_setup_vm_info

- name: Set MAC address fact if VM exists
  ansible.builtin.set_fact:
    home_assistant_setup_vm_mac_address: >-
      {{
          home_assistant_setup_vm_info.proxmox_vms[0].config.net0
          | regex_search('([0-9A-Fa-f]{2}[:-]){5}([0-9A-Fa-f]{2})')
          | lower
      }}
  when: home_assistant_setup_vm_info.proxmox_vms | length > 0

- name: Create empty VM shell if missing
  community.proxmox.proxmox_kvm:
    agent: "{{ vms_config.agent | default('1') }}"
    api_host: "{{ global_proxmox_api_host }}"
    api_user: "{{ global_proxmox_api_user }}"
    api_password: "{{ global_proxmox_api_password }}"
    node: "{{ vms_proxmox_node }}"
    vmid: "{{ home_assistant_setup_vmid | int }}"
    name: "{{ vms_vmname | default(inventory_hostname) }}"
    machine: "q35"
    scsihw: "{{ vms_config.scsihw | default('virtio-scsi-single') }}"
    cpu: "{{ vms_config.cpu | default('host') }}"
    bios: "ovmf"
    memory: "{{ vms_config.memory | default(2048) }}"
    cores: "{{ vms_config.cores | default(2) }}"
    sockets: "{{ vms_config.sockets | default(1) }}"
    ostype: "l26"
    serial:
      serial0: "{{ vms_config.serial | default('socket') }}"
    vga: "{{ vms_config.vga | default('serial0') }}"
    net:
      net0: "{{ vms_config.net0 | default('virtio,bridge=vmbr0') }}"
    efidisk0:
      storage: "{{ home_assistant_setup_disk_storage }}"
      format: raw
      efitype: "2m"
      pre_enrolled_keys: false
    state: present
  delegate_to: localhost
  when: home_assistant_setup_vm_info.proxmox_vms | length == 0
  register: home_assistant_setup_vm_create_result
  notify:
    - Create temporary directory for qcow2.xz extraction
    - Download Home Assistant QCOW2 image
    - Decompress qcow2.xz
    - Import qcow2 image
    - Remove temporary directory
    - Extract disk volume ID from import output
    - Attach unused disk using qm set
    - Configure boot order to boot from disk

- name: Set Mac address fact from created VM
  ansible.builtin.set_fact:
    home_assistant_setup_vm_mac_address: "{{ home_assistant_setup_vm_create_result.mac.net0 }}"
  when: home_assistant_setup_vm_mac_address is not defined

- name: Show Home Assistant VM creation result
  ansible.builtin.debug:
    msg: "Home Assistant VM {{ home_assistant_setup_vmid }} has MAC {{ home_assistant_setup_vm_mac_address }}."

- name: Flush handlers to download and prepare Home Assistant image
  ansible.builtin.meta: flush_handlers

- name: Start the Home Assistant VM
  community.proxmox.proxmox_kvm:
    api_host: "{{ global_proxmox_api_host }}"
    api_user: "{{ global_proxmox_api_user }}"
    api_password: "{{ global_proxmox_api_password }}"
    node: "{{ vms_proxmox_node }}"
    vmid: "{{ home_assistant_setup_vmid | int }}"
    state: started
  register: home_assistant_setup_start_vm_result
  delegate_to: localhost
  changed_when: home_assistant_setup_start_vm_result.changed

- name: Show confirmation message
  ansible.builtin.debug:
    msg: "Home Assistant VM (vmid {{ home_assistant_setup_vmid }}) has been created and started on Proxmox node {{ vms_proxmox_node }}."
  when: home_assistant_setup_start_vm_result is defined and home_assistant_setup_start_vm_result.changed

- name: Initialize home_assistant_setup_vm_interfaces by querying QEMU guest agent
  ansible.builtin.command: >
    qm guest cmd {{ home_assistant_setup_vmid }} network-get-interfaces
  register: home_assistant_setup_vm_interfaces
  delegate_to: "{{ vms_proxmox_node }}"
  retries: 30
  delay: 5
  until: home_assistant_setup_vm_interfaces.stdout is search('"ip-address"')
  changed_when: false
  failed_when: false

- name: Wait for VM to report an IP address on the host NIC using its MAC address
  ansible.builtin.command: >
    qm guest cmd {{ home_assistant_setup_vmid }} network-get-interfaces
  register: home_assistant_setup_vm_interfaces
  delegate_to: "{{ vms_proxmox_node }}"
  until: >-
    (home_assistant_setup_vm_interfaces.stdout | default('[]') | from_json
    | selectattr('hardware-address', 'equalto', (home_assistant_setup_vm_mac_address | lower | trim))
    | map(attribute='ip-addresses')
    | first | default([])) | length > 0
  retries: 30
  delay: 5
  changed_when: false
  failed_when: false

- name: Extract the VM's IPv4 address
  ansible.builtin.set_fact:
    home_assistant_setup_vm_ip_address: >-
      {{
        home_assistant_setup_vm_interfaces.stdout | default('[]') | from_json
        | selectattr('hardware-address', 'equalto', (home_assistant_setup_vm_mac_address | lower | trim))
        | map(attribute='ip-addresses')
        | flatten
        | selectattr('ip-address-type', 'equalto', 'ipv4')
        | map(attribute='ip-address')
        | first
      }}

- name: Wait for Home Assistant Web UI to become accessible
  ansible.builtin.uri:
    url: "http://{{ home_assistant_setup_vm_ip_address }}:8123/"
    status_code: 200
  retries: 30
  delay: 10
  register: home_assistant_setup_connection_check
  until: home_assistant_setup_connection_check.status == 200
  delegate_to: localhost

- name: Show Home Assistant access information
  ansible.builtin.debug:
    msg: "Home Assistant is accessible at http://{{ home_assistant_setup_vm_ip_address }}:8123/"
  when: home_assistant_setup_vm_ip_address is defined
