---

- name: Download code-server package
  ansible.builtin.get_url:
    url: "https://github.com/coder/code-server/releases/download/v{{ code_server_version }}/code-server_{{ code_server_version }}_amd64.deb"
    dest: "/tmp/code-server_{{ code_server_version }}_amd64.deb"
    mode: "0644"
  register: code_server_get_url_retval
  changed_when: code_server_get_url_retval.state is defined

- name: Install code-server package
  ansible.builtin.apt:
    deb: "/tmp/code-server_{{ code_server_version }}_amd64.deb"
    state: present

- name: Enable and start code-server service
  ansible.builtin.systemd:
    name: "code-server@{{ ansible_user_id }}"
    enabled: true
    state: started

- name: Cleanup downloaded file
  ansible.builtin.file:
    path: "/tmp/code-server_{{ code_server_version }}_amd64.deb"
    state: absent
