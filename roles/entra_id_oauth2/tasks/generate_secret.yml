---

- name: Remove existing credentials
  ansible.builtin.command: >
    az ad app credential list
    --id {{ item.oauth2_client_id }}
    --query "[].keyId" -o tsv
  register: entra_id_oauth2_existing_keys
  delegate_to: localhost
  changed_when: false

- name: Delete existing credentials
  ansible.builtin.command: >
    az ad app credential delete
    --id {{ item.oauth2_client_id }}
    --key-id {{ item_key }}
  loop: "{{ entra_id_oauth2_existing_keys.stdout_lines }}"
  loop_control:
    loop_var: item_key
  delegate_to: localhost
  when: entra_id_oauth2_existing_keys.stdout != ""
  changed_when: false

- name: Wait 5 seconds to avoid concurrency issues
  ansible.builtin.pause:
    seconds: 5

- name: Create client secret with CLI and retrieve new secret
  ansible.builtin.command: >
    az ad app credential reset
    --id {{ item.oauth2_client_id }}
    --append
    --display-name "Generated by Ansible on {{ ansible_date_time.date }}"
    --end-date {{ entra_id_oauth2_secret_expiry }}
    --query password -o tsv
  register: entra_id_oauth2_secret
  delegate_to: localhost
  changed_when: false
  retries: 8
  delay: 5
  until: entra_id_oauth2_secret.rc == 0

- name: Add secret to secret map
  ansible.builtin.set_fact:
    _entra_id_oauth2_secret_map: >-
      {{
        (_entra_id_oauth2_secret_map | default({}))
        | combine({ item.oauth2_client_id: (entra_id_oauth2_secret.stdout | default('')) })
      }}
