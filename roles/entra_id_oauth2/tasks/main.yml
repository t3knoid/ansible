---

- name: Ensure azure.azcollection required Python modules are installed
  ansible.builtin.pip:
    requirements: >-
      {{ python3_venv_folder }}/lib/python{{ python3_version }}/site-packages/ansible_collections/azure/azcollection/requirements.txt
    state: present
    virtualenv: "{{ python3_venv_folder }}"
  delegate_to: localhost

- name: Ensure azure-cli Python module installed
  ansible.builtin.pip:
    name: azure-cli
    state: present
    virtualenv: "{{ python3_venv_folder }}"
  delegate_to: localhost

# The number of days until the generated secret will expire.
# This variable is used in creation of the secret.
- name: Calculate secret expiry offset from today
  ansible.builtin.set_fact:
    entra_id_oauth2_secret_expiry: >-
      {{
        lookup(
          'pipe',
          'date -u -d "+' +
          (entra_id_oauth2_secret_expiry_offset_days | string) +
          ' days" +%Y-%m-%dT%H:%M:%SZ'
        )
      }}
  delegate_to: localhost
  run_once: true

# Establishes a session and writes a token cache under ~/.azure
# before generating secrets
- name: Login with service principal
  ansible.builtin.command: >
    az login --service-principal
    --username {{ global_azure_sp_client_id }}
    --password {{ global_azure_sp_secret }}
    --tenant {{ global_azure_tenant }}
  delegate_to: localhost
  changed_when: false

# The register_app.yml task file creates or retrieves
# Entra ID applications for each site in the
# {{ rproxy_setup_sites }} list. Once an application
# is created or retrieved, a client secret is generated
# for that application. The client ID and client secret
# are stored in the variable
# {{ entra_id_oauth2_site_client_id_map }}. This variable
# A map of server_name to client ID and client secret is
# then used to build an updated list of sites with the
# correct client IDs and client secrets injected. This
# updated list is stored in the variable
# {{ entra_id_oauth2_updated_sites }} for use in downstream
# tasks.
- name: Register Entra ID application for each site
  ansible.builtin.include_tasks: register_app.yml
  loop: "{{ rproxy_setup_sites }}"
  loop_control:
    label: "{{ item.server_name }}"
  register: entra_id_oauth2_app_results
  when: item.use_oauth2 is defined and item.use_oauth2

- name: Build updated list with secrets
  ansible.builtin.set_fact:
    entra_id_oauth2_updated_sites: []

- name: Append each site with injected secret
  no_log: true
  ansible.builtin.set_fact:
    entra_id_oauth2_updated_sites: >-
      {{
        (entra_id_oauth2_updated_sites | default([])) +
        [ item | combine({
            'oauth2_client_id': ((entra_id_oauth2_site_client_map | default({})).get(item.server_name, {}).get('client_id', item.oauth2_client_id)),
            'oauth2_client_secret': ((entra_id_oauth2_site_client_map | default({})).get(item.server_name, {}).get('client_secret', item.oauth2_client_secret))
          }, recursive=True)
        ]
      }}
  loop: "{{ rproxy_setup_sites }}"
  loop_control:
    label: "{{ item.server_name }}"
  when: item.use_oauth2 is defined and item.use_oauth2

- name: Update rproxy_setup_sites with injected client IDs and secrets
  ansible.builtin.set_fact:
    rproxy_setup_sites: "{{ entra_id_oauth2_updated_sites }}"
  delegate_to: localhost
