---
- name: Install required packages
  ansible.builtin.apt:
    name:
      - adduser
      - libfontconfig1
      - musl
    state: present
    update_cache: true
  become: true

- name: Download and Extract Grafana
  ansible.builtin.unarchive:
    src: "{{ grafana_setup_dl_url }}"
    dest: "/opt/"
    remote_src: true
    creates: "{{ grafana_setup_install_dir }}"
    mode: "0755"

- name: Create symlink to Grafana installation
  ansible.builtin.file:
    src: "{{ grafana_setup_install_dir }}"
    dest: "/opt/grafana"
    state: link
    force: true

- name: Create Grafana data directory
  ansible.builtin.file:
    path: "{{ grafana_setup_home_dir }}"
    state: directory
    owner: grafana
    group: grafana
    mode: "0755"

- name: Create Grafana log directory
  ansible.builtin.file:
    path: "{{ grafana_setup_logs_dir }}"
    state: directory
    owner: grafana
    group: grafana
    mode: "0755"

- name: Create Grafana plugins directory
  ansible.builtin.file:
    path: "{{ grafana_setup_plugins_dir }}"
    state: directory
    owner: grafana
    group: grafana
    mode: "0755"

- name: Create Grafana pid file directory
  ansible.builtin.file:
    path: "{{ grafana_setup_pid_dir }}"
    state: directory
    owner: grafana
    group: grafana
    mode: "0750"

- name: Create Grafana provisioning directory
  ansible.builtin.file:
    path: "{{ grafana_setup_provisioning_dir }}"
    state: directory
    owner: grafana
    group: grafana
    mode: "0750"

- name: Create Grafana provisioning/plugins directory
  ansible.builtin.file:
    path: "{{ grafana_setup_provisioning_dir }}/plugins"
    state: directory
    owner: grafana
    group: grafana
    mode: "0750"

- name: Create Grafana configuration directory
  ansible.builtin.file:
    path: "{{ grafana_setup_conf_dir }}"
    state: directory
    owner: grafana
    group: grafana
    mode: "0750"

- name: Copy Grafana configuration file
  ansible.builtin.template:
    src: defaults.ini.j2
    dest: "{{ grafana_setup_config_file }}"
    owner: "{{ grafana_setup_user }}"
    group: "{{ grafana_setup_group }}"
    mode: "0640"
    backup: true

- name: Copy Grafana defaults file
  ansible.builtin.template:
    src: defaults.j2
    dest: "{{ grafana_setup_environment_file }}"
    owner: "{{ grafana_setup_user }}"
    group: "{{ grafana_setup_group }}"
    mode: "0640"
    backup: true

- name: Set ownership for Grafana directory
  ansible.builtin.file:
    path: "{{ grafana_setup_home_dir }}"
    owner: "{{ grafana_setup_user }}"
    group: "{{ grafana_setup_group }}"
    recurse: true

- name: Create Grafana systemd service file
  ansible.builtin.template:
    src: grafana-server.service.j2
    dest: "{{ grafana_setup_service_file }}"
    owner: "{{ grafana_setup_user }}"
    group: "{{ grafana_setup_group }}"
    mode: "0640"

- name: Reload systemd daemon
  ansible.builtin.systemd:
    daemon_reload: true

- name: Enable and start grafana service
  ansible.builtin.systemd:
    name: grafana-server
    enabled: true
    state: started
