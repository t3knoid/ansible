---

- name: Backup PostgreSQL database using pg_dump
  ansible.builtin.shell: |
    set -euo pipefail
    pg_dump -U {{ grafana_setup_db_user }} -h {{ grafana_setup_pg_host }} -Fc \
      --file={{ grafana_setup_backup_path }} {{ grafana_setup_db_name }}
  args:
    executable: /bin/bash
  become_user: postgres
  register: pg_backup_result
  failed_when: pg_backup_result.rc != 0
  changed_when: true

- name: Keep only the latest 3 backups
  ansible.builtin.shell: |
    ls -1t {{ grafana_setup_mount_point }}/{{ grafana_setup_backup_prefix }}*.sqlc | tail -n +4 | xargs -r rm -f
  args:
    executable: /bin/bash
  become: true
  become_user: postgres
