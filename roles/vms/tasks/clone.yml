---

- name: Clone Ubuntu 24.04 template
  community.general.proxmox_kvm:
    api_host: "{{ global_proxmox_api_host }}"
    api_user: "{{ global_proxmox_api_user }}"
    api_password: "{{ global_proxmox_api_password }}"
    node: "{{ vms_proxmox_node }}"
    clone: "{{ global_os['{{ vms_os }}'].template }}"
    name: "{{ vms_name | default(inventory_hostname) }}"
    storage: linstor_storage
    timeout: 500
    state: present
  delegate_to: localhost
  register: vms_cloned_vm_info

- name: Add second disk
  community.general.proxmox_disk:
    api_host: "{{ global_proxmox_api_host }}"
    api_user: "{{ global_proxmox_api_user }}"
    api_token_id: "{{ global_proxmox_api_token_id }}"
    api_token_secret: "{{ global_proxmox_api_token }}"
    api_password: "{{ global_proxmox_api_password }}"
    vmid: "{{ vms_cloned_vm_info.vmid  }}"
    disk: virtio1
    backup: "{{ vms_config.disk2.backup | default(true) }}"
    cache: none
    storage: "{{ vms_config.disk2.storage | default(local_thin) }}"
    size: "{{ vms_config.disk2.size | default(20) }}"
    state: present
  delegate_to: localhost
  when: vms_config.vms_disk2 is defined

- name: Migrate new image
  community.general.proxmox_kvm:
    api_host: "{{ global_proxmox_api_host }}"
    api_user: "{{ global_proxmox_api_user }}"
    api_password: "{{ global_proxmox_api_password }}"
    node: "{{ vms_migrate_to_node }}"
    vmid: "{{ vms_cloned_vm_info.vmid  }}"
    migrate: true
    state: present
  delegate_to: localhost

- name: "Retrieve {{ inventory_hostname }} information"
  community.general.proxmox_vm_info:
    api_host: "{{ global_proxmox_api_host }}"
    api_user: "{{ global_proxmox_api_user }}"
    api_password: "{{ global_proxmox_api_password }}"
    node: "{{ vms_migrate_to_node }}"
    name: "{{ vms_name | default(inventory_hostname) }}"
    config: current
  delegate_to: localhost
  register: vms_current_vm_info

- name: "Display {{ inventory_hostname }} information"
  debug:
    var: vms_current_vm_info