---

- name: Get a list of vms
  ansible.builtin.uri:
    url: 'https://{{ global_proxmox_api_host }}:8006/api2/json/cluster/resources?type=vm'
    method: GET
    headers:
      Authorization: "PVEAPIToken={{ global_proxmox_api_user }}!{{ global_proxmox_api_token_id }}={{ global_proxmox_api_token }}"
    follow_redirects: safe
    validate_certs: false
  register: vm_list
  delegate_to: localhost

- name: Get vmid
  ansible.builtin.set_fact:
    vms_vmid: "{{ item.vmid }}"
  with_items: "{{ vm_list.json.data }}"
  loop_control:
    label: "{{ item.name }}"
  when: item.name == vms_name

- name: Get node
  ansible.builtin.set_fact:
    vms_proxmox_node: "{{ item.node }}"
  with_items: "{{ vm_list.json.data }}"
  loop_control:
    label: "{{ item.name }}"
  when: item.name == inventory_hostname

- name: Shutdown VM
  ansible.builtin.uri:
    url: 'https://{{ global_proxmox_api_host }}:8006/api2/json/nodes/{{ vms_proxmox_node }}/qemu/{{ vms_vmid }}/status/shutdown'
    method: POST
    headers:
      Authorization: "PVEAPIToken={{ global_proxmox_api_user }}!{{ global_proxmox_api_token_id }}={{ global_proxmox_api_token }}"
    follow_redirects: safe
    validate_certs: false
  register: vms_shutdown_result
  delegate_to: localhost
  when: vms_vmid is defined

- name: Make sure virtual machine is really stopped
  ansible.builtin.uri:
    url: 'https://{{ global_proxmox_api_host }}:8006/api2/json/nodes/{{ vms_proxmox_node }}/qemu/{{ vms_vmid }}/status/current'
    method: Get
    headers:
      Authorization: "PVEAPIToken={{ global_proxmox_api_user }}!{{ global_proxmox_api_token_id }}={{ global_proxmox_api_token }}"
    follow_redirects: safe
    validate_certs: false
  register: vms_status_result
  retries: 5
  delay: 5
  until: vms_status_result.json.data.status == "stopped"
  delegate_to: localhost
  when: vms_vmid is defined

- name: Show vms_status_result
  debug:
    var: vms_status_result.json.data.status
