---

- name: Install Python
  ansible.builtin.apt:
    name:
      - "python{{ python3_version }}"
      - python3-venv
    state: present
    update_cache: true
  become: true

- name: Create a directory for the virtual environment
  ansible.builtin.file:
    path: "/opt/python_{{ python3_version }}"
    state: directory
    mode: "0774"
    group: "ansible"
  become: true

- name: Create Python virtual environment
  ansible.builtin.command: "python3 -m venv /opt/python_{{ python3_version }}"
  register: python3_command_return
  changed_when: python3_command_return.rc !=0

- name: Install Python pip
  ansible.builtin.apt:
    name: python3-pip
    state: present
  become: true

- name: Install Python modules
  ansible.builtin.pip:
    name: "{{ item }}"
    virtualenv: "/opt/python_{{ python3_version }}"
    state: present
  loop: "{{ python3_modules_to_install }}"
