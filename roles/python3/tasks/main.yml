---

- name: Remove legacy deadsnakes.list file
  ansible.builtin.file:
    path: "/etc/apt/sources.list.d/deadsnakes.list"
    state: absent

- name: Remove existing Deadsnakes repo list file
  ansible.builtin.file:
    path: "/etc/apt/sources.list.d/deadsnakes-ubuntu-ppa-noble.sources"
    state: absent

- name: Add deadsnakes apt repository.
  ansible.builtin.apt_repository:
    repo: ppa:deadsnakes/ppa
    filename: deadsnakes-ubuntu-ppa-noble.sources
    mode: "0644"
    update_cache: false
    state: present

- name: Update apt cache
  ansible.builtin.apt:
    update_cache: true

- name: Install Python packages
  ansible.builtin.apt:
    name: "{{ item }}"
    state: present
  loop: "{{ python3_packages_to_install }}"

# Cannot use ansible.builtin.pip here so using shell instead
- name: Install Python packaging module
  ansible.builtin.shell: |
    umask 0022
    if ! {{ python3_venv_folder }}/bin/python3 -c "import packaging" &> /dev/null; then
      {{ python3_venv_folder }}/bin/python3 -m pip install packaging==25
    else
      echo "packaging module already installed."
    fi
  register: pip_install_output
  changed_when: "'Successfully installed packaging' in pip_install_output.stdout"
  failed_when: pip_install_output.rc != 0 and 'packaging module already installed' not in pip_install_output.stdout

- name: Include venv.yml tasks
  ansible.builtin.include_tasks: venv.yml
