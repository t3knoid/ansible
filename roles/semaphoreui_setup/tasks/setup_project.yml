---

# This should not be called directly, only via setup_project.yml

- name: Set current project data
  ansible.builtin.set_fact:
    project_data: >-
      {{
        semaphoreui_setup_projects |
        selectattr('name', 'equalto', project_name ) |
        first
      }}

- name: Get existing environments
  changed_when: false
  check_mode: false
  ansible.builtin.uri:
    use_proxy: false
    url: "{{ semaphoreui_setup_api_base }}/project/{{ project_id }}/environment"
    method: GET
    headers:
      Content-Type: application/json
      Accept: application/json
      Authorization: "Bearer {{ semaphoreui_setup_api_token }}"
    status_code: 200
    timeout: 5
  register: retrieved_environments_response

- name: Get existing keys
  changed_when: false
  check_mode: false
  ansible.builtin.uri:
    use_proxy: false
    url: "{{ semaphoreui_setup_api_base }}/project/{{ project_id }}/keys"
    method: GET
    headers:
      Content-Type: application/json
      Accept: application/json
      Authorization: "Bearer {{ semaphoreui_setup_api_token }}"
    status_code: 200
    timeout: 5
  register: retrieved_keys_response

- name: Get existing repositories
  ansible.builtin.uri:
    url: "{{ semaphoreui_setup_api_base }}/project/{{ project_id }}/repositories"
    method: GET
    headers:
      Content-Type: application/json
      Accept: application/json
      Authorization: "Bearer {{ semaphoreui_setup_api_token }}"
    status_code: 200
    timeout: 5
  register: retrieved_repos_response

- name: Get existing inventories
  changed_when: false
  check_mode: false
  ansible.builtin.uri:
    use_proxy: false
    url: "{{ semaphoreui_setup_api_base }}/project/{{ project_id }}/inventory"
    method: GET
    headers:
      Content-Type: application/json
      Accept: application/json
      Authorization: "Bearer {{ semaphoreui_setup_api_token }}"
    status_code: 200
    timeout: 5
  register: retrieved_inventories_response

- name: Get existing views
  changed_when: false
  check_mode: false
  ansible.builtin.uri:
    use_proxy: false
    url: "{{ semaphoreui_setup_api_base }}/project/{{ project_id }}/views"
    method: GET
    headers:
      Content-Type: application/json
      Accept: application/json
      Authorization: "Bearer {{ semaphoreui_setup_api_token }}"
    status_code: 200
    timeout: 5
  register: retrieved_views_response

- name: Get existing templates
  changed_when: false
  check_mode: false
  ansible.builtin.uri:
    use_proxy: false
    url: "{{ semaphoreui_setup_api_base }}/project/{{ project_id }}/templates"
    method: GET
    headers:
      Content-Type: application/json
      Accept: application/json
      Authorization: "Bearer {{ semaphoreui_setup_api_token }}"
    status_code: 200
    timeout: 5
  register: retrieved_templates_response

- name: Add project key stores
  include_tasks: setup_keystores.yml
  vars:
      current_project_id: "{{ project_id }}"
      current_project_name: "{{ project_name }}"
      project_data_to_add: "{{ project_data }}"
      retrieved_keys: "{{ retrieved_keys_response.json }}"
  when: project_data.keystores is defined and (project_data.keystores | default([])  | length > 0)

- name: Add project repositories
  include_tasks: setup_repositories.yml
  vars:
      current_project_id: "{{ project_id }}"
      current_project_name: "{{ project_name }}"
      project_data_to_add: "{{ project_data }}"
      retrieved_repos: "{{ retrieved_repos_response.json }}"
      retrieved_keys: "{{ retrieved_keys_response.json }}"
  when: project_data.repositories is defined and (project_data.repositories | default([])  | length > 0)

- name: Add project inventories
  include_tasks: setup_inventories.yml
  vars:
      current_project_id: "{{ project_id }}"
      current_project_name: "{{ project_name }}"
      project_data_to_add: "{{ project_data }}"
      retrieved_inventories: "{{ retrieved_inventories_response.json }}"
      retrieved_repos: "{{ retrieved_repos_response.json }}"
      retrieved_keys: "{{ retrieved_keys_response.json }}"
  when: project_data.inventories is defined and (project_data.inventories | default([])  | length > 0)

- name: Add project views
  include_tasks: setup_views.yml
  vars:
      current_project_id: "{{ project_id }}"
      current_project_name: "{{ project_name }}"
      project_data_to_add: "{{ project_data }}"
      retrieved_views: "{{ retrieved_keys_response.json }}"
  when: project_data.views is defined and (project_data.views | default([])  | length > 0)

- name: Add project task templates
  include_tasks: setup_templates.yml
  vars:
    current_project_id: "{{ project_info.value }}"
    current_project_name: "{{ project_info.key }}"
    project_data_to_add: "{{ project_data }}"
    retrieved_templates: "{{ retrieved_templates_response.json }}"
    retrieved_keys: "{{ retrieved_keys_response.json }}"
    retrieved_inventories: "{{ retrieved_inventories_response.json }}"
    retrieved_views: "{{ retrieved_views_response.json }}"
    retrieved_repos: "{{ retrieved_repos_response.json }}"
    retrieved_environments: "{{ retrieved_environments_response.json }}"
  when: project_data.templates is defined and (project_data.templates | default([])  | length > 0)
  