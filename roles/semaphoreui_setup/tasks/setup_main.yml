---

# Set up Semaphore UI using its api
# https://docs.semaphoreui.com/administration-guide/api/

- name: Include setup_auth.yml tasks
  ansible.builtin.include_tasks: setup_auth.yml
  when: semaphoreui_setup_api_token is not defined

- name: Include setup_users.yml tasks
  ansible.builtin.include_tasks: setup_users.yml

- name: Include setup_projects.yml tasks
  ansible.builtin.include_tasks: setup_projects.yml

# If the playbook fails before this point, make sure to manually expire the token in the UI
- name: Expire the token
  ansible.builtin.uri:
    url: "{{ semaphoreui_setup_api_base }}/user/tokens/{{ semaphoreui_setup_api_token}}"
    method: DELETE
    headers:
      Content-Type: application/json
      Accept: application/json
      Authorization: "Bearer {{ semaphoreui_setup_api_token }}"
    status_code: 204
  when: semaphoreui_setup_api_token is defined