---

# This should not be called directly, only via setup_projects.yml

- name: Set current project data
  ansible.builtin.set_fact:
    current_project_data: >-
      {{
        semaphoreui_setup_projects |
        selectattr('name', 'equalto', current_project_name) |
        first
      }}

- name: Enumerate key stores
  changed_when: false
  check_mode: false
  ansible.builtin.uri:
    use_proxy: false
    url: "{{ semaphoreui_setup_api_base }}/project/{{ current_project_id }}/keys"
    method: GET
    headers:
      Content-Type: application/json
      Accept: application/json
      Authorization: "Bearer {{ semaphoreui_setup_api_token }}"
    status_code: 200
    timeout: 5
  register: existing_keystores_response

- name: Normalize inventories in project {{ current_project_name }} if not already present
  ansible.builtin.include_tasks: setup_inventory.yml
  vars:
    current_project_keystores: "{{ existing_keystores_response.json }}"
    current_project_inventory: "{{ current_inventory }}"
  loop: "{{ current_project_data.inventories }}"
  loop_control:
    label: "{{ current_inventory.name }}"
    loop_var: current_inventory
