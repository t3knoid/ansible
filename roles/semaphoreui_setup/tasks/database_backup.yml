---

- name: Ensure backup directory exists
  ansible.builtin.file:
    path: "{{ semaphoreui_setup_backup_dir }}"
    state: directory
    owner: postgres
    group: postgres
    mode: '0755'

- name: Backup PostgreSQL database using pg_dump
  ansible.builtin.shell: |
    set -euo pipefail
    pg_dump -U {{ semaphoreui_setup_db_user }} -h {{ semaphoreui_setup_pg_host }} -Fc \
      --file={{ semaphoreui_setup_backup_path }} {{ semaphoreui_setup_db_name }}
  args:
    executable: /bin/bash
  become_user: postgres
  register: semaphoreui_setup_pg_backup_result
  failed_when: semaphoreui_setup_pg_backup_result.rc != 0
  changed_when: true

- name: Keep only the latest 3 backups
  ansible.builtin.shell: |
    ls -1t {{ semaphoreui_setup_backup_dir }}/{{ semaphoreui_setup_backup_prefix }}*.sqlc | tail -n +4 | xargs -r rm -f
  args:
    executable: /bin/bash
  become: true
  become_user: postgres
