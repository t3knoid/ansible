---

# This should not be called directly, only via setup_projects.yml


- name: "Enumerate views"
  changed_when: false
  check_mode: false
  ansible.builtin.uri:
    use_proxy: false
    url: "{{ semaphoreui_setup_api_base }}/project/{{ current_project_id }}/views"
    method: GET
    headers:
      Content-Type: application/json
      Accept: application/json
      Authorization: "Bearer {{ semaphoreui_setup_api_token }}"
    status_code: 200
    timeout: 5
  register: existing_views_response

- name: Parse existing views names
  ansible.builtin.set_fact:
    existing_views_titles: >-
      {{
        existing_views_response.json | map(attribute='title') | list
      }}
  when: existing_views_response.json is defined

- name: Create views in project {{ current_project_name }} if not already present
  ansible.builtin.uri:
    url: "{{ semaphoreui_setup_api_base }}/project/{{ current_project_id }}/views"
    method: POST
    headers:
      Content-Type: application/json
      Accept: application/json
      Authorization: "Bearer {{ semaphoreui_setup_api_token }}"
    body_format: json
    body: >-
      {{
        current_view | combine({ 'project_id': (current_project_id | int) })
      }}
    status_code: 200
  when: current_view.title not in existing_views_titles
  loop: "{{ current_project_data.views }}"
  loop_control:
    label: "{{ current_view.title }}"
    loop_var: current_view
