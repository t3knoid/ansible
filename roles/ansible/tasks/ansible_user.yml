---

- name: Get the current user
  ansible.builtin.command: whoami
  register: ansible_current_user
  changed_when: false
  delegate_to: localhost

- name: Ensure ansible group exists
  ansible.builtin.group:
    name: ansible
    state: present

- name: Add current user to ansible group
  ansible.builtin.user:
    name: "{{ ansible_current_user.stdout }}"
    generate_ssh_key: true
    groups: ansible
    append: true
    shell: /bin/bash
  become: true

- name: Ensure sudoers.d directory exists
  ansible.builtin.file:
    path: /etc/sudoers.d
    state: directory
    mode: '0755'
  become: true

- name: Add 'ansible' group to sudoers with NOPASSWD
  ansible.builtin.lineinfile:
    path: /etc/sudoers.d/99_ansible
    create: true
    state: present
    line: '%ansible ALL=(ALL) NOPASSWD:ALL'
    mode: '0644'
    validate: 'visudo -cf %s'
  become: true