---
# defaults file for graphite_setup

graphite_setup_whisper_version: master
graphite_setup_carbon_version: master
graphite_setup_graphite_web_version: master
graphite_setup_modules_to_install:
  - "https://github.com/graphite-project/whisper/tarball/{{ graphite_setup_whisper_version }}"
  - "https://github.com/graphite-project/carbon/tarball/{{ graphite_setup_carbon_version }}"
  - "https://github.com/graphite-project/graphite-web/tarball/{{ graphite_setup_graphite_web_version }}"
graphite_setup_gunicorn_host: 127.0.0.1
graphite_setup_gunicorn_port: 8080

graphite_setup_home: "/opt/graphite"
graphite_setup_pg_database: graphite_db
graphite_setup_pg_user: graphite
# graphite_setup_pg_password is in vault.yml
graphite_setup_pg_packages:
  - libpq-dev
  - python3-psycopg2


graphite_setup_nginx_site_config: |
  upstream graphite {
      server {{ graphite_setup_gunicorn_host }}:{{ graphite_setup_gunicorn_port }} fail_timeout=0;
  }

  server {
      listen 80 default_server;

      server_name {{ inventory_hostname }};

      root {{ graphite_setup_home }}/webapp;

      access_log /var/log/nginx/graphite.access.log;
      error_log  /var/log/nginx/graphite.error.log;

      location = /favicon.ico {
          return 204;
      }

      # serve static content from the "content" directory
      location /static {
          alias {{ graphite_setup_home }}/webapp/content;
          expires max;
      }

      location / {
          try_files $uri @graphite;
      }

      location @graphite {
          proxy_pass_header Server;
          proxy_set_header Host $http_host;
          proxy_redirect off;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Scheme $scheme;
          proxy_connect_timeout 10;
          proxy_read_timeout 10;
          proxy_pass http://{{ inventory_hostname }};
      }
  }
