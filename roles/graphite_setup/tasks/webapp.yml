---

# see https://graphite.readthedocs.io/en/latest/config-webapp.html
# nginx will proxy requests for Gunicorn

- name: Install Gunicorn
  ansible.builtin.pip:
    name: gunicorn
    virtualenv: "/opt/python_{{ python3_version }}"
    extra_args: "--prefix={{ graphite_setup_home }}"
    umask: "0022"
    state: present

- name: Configure Graphite systemd startup script
  ansible.builtin.template:
    src: "{{ item.key }}"
    dest: "{{ item.value }}"
    mode: "0644"
  with_dict:
    graphite-web.service.j2: /etc/systemd/system/graphite-web.service
    graphite-web.socket.j2: /etc/systemd/system/graphite-web.socket
  become: true
 
- name: Configure /var/log/nginx/graphite.access.log
  ansible.builtin.file:
    path: /var/log/nginx/graphite.access.log
    state: touch
    owner: www-data
    mode: "0640"
  become: true

- name: Configure /var/log/nginx/graphite.error.log
  ansible.builtin.file:
    path: /var/log/nginx/graphite.error.log
    state: touch
    owner: www-data
    mode: "0640"
  become: true

- name: Enable gunicorn service
  ansible.builtin.service: 
    name="graphite-web{{ (ansible_service_mgr == 'systemd') | ternary('.service', '') }}"
    enabled=yes
  become: true

- name: Import Nginx role
  ansible.builtin.import_role:
    name: nginx_setup
  vars:
    nginx_setup_site_name: "{{ inventory_hostname }}"
    nginx_setup_site_config: "{{ graphite_setup_nginx_site_config }}"
