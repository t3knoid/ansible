---

# https://graphite.readthedocs.io/en/latest/config-database-setup.html

- name: Copy local_settings.py
  ansible.builtin.template:
    src: local_settings.py.j2
    dest: "{{ graphite_setup_home }}/lib/python3.12/site-packages/opt/graphite/webapp/graphite/local_settings.py"
    mode: "0644"

- name: Import postgresql_setup role
  ansible.builtin.import_role:
    name: postgresql_setup
  vars:
    nginx_setup_site_name: "{{ inventory_hostname }}"
    nginx_setup_site_config: "{{ graphite_setup_nginx_site_config }}"
  become: true

- name: Create Graphite PostgreSQL database
  community.postgresql.postgresql_db:
    name: "{{ graphite_setup_pg_database }}"
  become_user: postgres
  become: true

- name: Ensure Graphite database user is created
  community.postgresql.postgresql_user:
    name: "{{ graphite_setup_pg_user }}"
    password: "{{ graphite_setup_pg_password }}"
    state: present
  become_user: postgres
  become: true

- name: Grant Graphite user ALL privilege to graphite database
  community.postgresql.postgresql_privs:
    database: "{{ graphite_setup_pg_database }}"
    objs: ALL_IN_SCHEMA
    roles: "{{ graphite_setup_pg_user }}"
    state: present
    privs: "ALL"
  become_user: postgres
  become: true

- name: Restart PostgreSQL to apply changes
  ansible.builtin.service:
    name: postgresql
    state: restarted
  become: true