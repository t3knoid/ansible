---

# https://graphite.readthedocs.io/en/latest/config-database-setup.html

- name: Install psycopg2
  ansible.builtin.pip:
    name: "psycopg2"
    virtualenv: "{{ graphite_setup_venv }}"
    umask: "0022"
    state: present
    extra_args: >
      --config-settings="--prefix={{ graphite_setup_venv }}"
  become: false

- name: Import postgresql_setup role
  ansible.builtin.import_role:
    name: postgresql_setup
  become: true

- name: Create Graphite PostgreSQL database
  community.postgresql.postgresql_db:
    name: "{{ graphite_setup_pg_database }}"
  become_user: postgres
  become: true

- name: Ensure Graphite database user is created
  community.postgresql.postgresql_user:
    name: "{{ graphite_setup_pg_user }}"
    password: "{{ graphite_setup_pg_password }}"
    state: present
  become_user: postgres
  become: true

- name: Grant Graphite user ALL privilege to graphite database
  community.postgresql.postgresql_privs:
    database: "{{ graphite_setup_pg_database }}"
    objs: ALL_IN_SCHEMA
    roles: "{{ graphite_setup_pg_user }}"
    state: present
    privs: "ALL"
  become_user: postgres
  become: true

- name: Update pg_hba.conf to use md5 authentication
  community.postgresql.postgresql_pg_hba:
    dest: /etc/postgresql/{{ postgresql_setup_version }}/main/pg_hba.conf
    contype: local
    users: all
    databases: all
    method: md5
  become: true

- name: Update pg_hba.conf to allow access using host ip address 
  community.postgresql.postgresql_pg_hba:
    dest: /etc/postgresql/{{ postgresql_setup_version }}/main/pg_hba.conf
    contype: host
    users: all
    source: "{{ hostvars[groups['pgdb'] | first]['ansible_default_ipv4']['address'] }}/32"
    databases: all
    method: md5
  become: true

- name: Restart PostgreSQL to apply changes
  ansible.builtin.service:
    name: postgresql
    state: restarted
  become: true

- name: Initialize database here
  ansible.builtin.shell: |
    {{ graphite_setup_venv }}/bin/django-admin.py migrate --settings=graphite.settings
  environment:
    PYTHONPATH: "{{ graphite_setup_venv }}/webapp"
  args:
    creates: "{{ graphite_setup_venv }}/migrate.done"
  become: true